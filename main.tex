\input{preamble}

\usepackage{comment}

\begin{document}

\input{titlepage}

\pagestyle{fancy}

\fancyhead{} 
\fancyfoot{}
\cfoot{\thepage}
\renewcommand{\headrulewidth}{0pt}
\setcounter{page}{2}

\tableofcontents

\newpage
\setlength{\parskip}{0.5cm}
\parindent=1cm
\onehalfspacing

\section{Аннотация}

В данной выпускной квалификационной работе рассматриваются методы автоматического анализа минерального состава руд по фотографиям аншлифов, а так же разработан и реализован один из таких методов, основанный на применении сверточных нейронных сетей.

\newpage
\section{Введение}

\subsection{Актуальность}
Даже   при   современном   уровне   развития   методов   анализа   вещества   в   рудной   геологии остаётся важная задача -- анализ   минерального   состава   руд   и   вмещающих   пород. Такой анализ включает в себя определение минерального состава, качественную оценку соотношения различных минералов, а также исследования структурно-текстурных особенностей конкретных горных пород. В первую очередь, это важно при поиске месторождений и определения их промышленного типа -- из этого типа выбирается будущая методология   добычи   полезного   ископаемого. Во вторую очередь, из конкретных соотношений минеральных агрегатов выбирается методология обогащения руд до требуемых металлургическими комбинатами кондиций. На данный момент единственным доступным способом изучения минерального состава является оптический, то есть исследование подготовленных шлифов и   \textit{аншлифов} под микроскопом. Аншлиф – специально подготовленный препарат для изучения непрозрачных минералов под микроскопом в отражённом свете. Представляет из себя небольшой каменный образец
руды или рудного прожилка, отполированный до зеркального блеска с одной стороны. Данная задача является сложной и трудоёмкой. К геологам-поисковикам, геологам-разведчикам и обогатителям, занятым в этой сфере, предъявляются высокие требования квалификации. При этом риск ошибки остаётся на высоком уровне. \par Одно из главных преимуществ использования автоматических методов анализа – точный и качественный подсчёт минеральных агрегатов, что невозможно осуществить человеческим глазом. Также компьютерная обработка фотографий аншлифов поможет составлять наборы данных большого объема за короткий промежуток времени, что приведёт к значительному удешевлению лабораторных работ, связанных с поиском и добычей полезных ископаемых.

\subsection{Структура работы}
В первой главе содержится аннотация с кратким описанием данной работы. Во второй главе представлена актуальность данной задачи. В третьей главе сформулированы цели и задачи работы. В четвертой главе представ- лен обзор существующих методов. В пятой главе описана предлагаемый метод. Шестая глава содержит алгоритм, предложенный для решения проблемы несбалансированности данных. В седьмой главе представлен список используемой литературы.

\newpage
\section{Постановка задачи}
В качестве материала для исследования используются фотографии аншлифов, на которых присутствуют восемь минералов:
\begin{enumerate}[nosep]
    \item Br - борнит
    \item Kvl - ковелин
    \item Py - пирит
    \item Mrc - марказит
    \item Sh - сфалерит
    \item Ccp - халькопирит
    \item Gl - галенит
    \item Tnt - тенантит-тетраидрит
\end{enumerate}
\par
Коллекция образцов, используемых в работе, была предоставлена кафедрой Геологии,
Геохимии и Экономики Полезных Ископаемых геологического факультета МГУ.
Коллекцию начал собирать выдающийся геолог СССР – Ф.П. Мельников, который посетил
более 30 месторождений. В последствии сотрудники кафедры продолжили его дело и на
данный момент кафедральная коллекция содержит образцы руд большинства
месторождений бывшего СССР. 
\par Используемые изображения имеют разрешение $3396 \times 2547$ пикселей. Тренировочный набор состоит из 46 размеченных изображений. Все изображения были получены на фотоаппарат Canon G10 с использованием микроскопа ZEISS Axioscop 40.
\par
Требуется разработать и программно реализовать алгоритм, позволяющий проводить сегментацию (сопоставление каждому пикслею изображения метки соответствующего класса) с целью определения минерального состава аншлифа. 
\par
В данной работе планируется проводить сегментацию следующих минералов:
\begin{enumerate}[nosep]
    \item \textbf{Sh} - сфалерит
    \item \textbf{Py/Mrc} - пирит и марказит
    \item \textbf{Gl} - галенит
\end{enumerate}
Все остальные минералы вместе с неразмеченными пикселями будут относиться к классу \textbf{Background}.
\newline
\begin{figure}[H]
    \includegraphics[width=\textwidth]{pics/segm_ex2.png}
    \centering
    \caption{Слева - фотография аншлифа. Справа - экспертная разметка изображения, выполненная геологом.}
\end{figure}

\newpage
\section{Обзор существующих методов}
Сегментация - это процесс разбиения цифрового изображения на различные сегменты (наборы пикселей), включащий в себя
определение и изоляцию пикселей, принадлежащих к одному классу \cite{martinez2007petrographic}.
В анализе минералов обычно используется сегментация, основанная на выделении границ и областей, или всего вместе. \par
Существующие алгоритмы диагностики минералов основываются на статистическом анализе изображений.
В \cite{berrezueta2016ore} описан следующий метод:
\begin{enumerate}[nosep]
    \item Вычисляются градации серого для каждого минерала на фотографии. Сверточные ядра размером $10\times 10$ накладываются на области, которые можно точно отнести к определенным минералам.
    \item Для минералов, изученных на предыдущем шаге вычисляются среднее $(x)$ и стандартное отклонение $(\sigma)$. Диапазоны сегментации определяются как $(x \pm \sigma)$, с уровнем заначимости $Y: 99.9\%$.
    \item Диапазоны сегментации для минерала 1 сохраняются в группе 1.
    \item Выбирается новый минерал (минерал 2) на изображении в группе 1 и шаги 1) - 3) повторяются, пока все минералы не будут обработаны в этой группе.
    \item Выбирается новое изображение (группа 2) и повторяются шаги 1-4.
\end{enumerate}
\par Установив диапазоны сегментации для каждого минерала на всех спектральных изображениях, окончательная сегментация получается как пересечение всех частичных сегментаций (применяя классификатор минимальной дистанции Махаланобиса). Предполагая нормальное распределение градаций серого ($Y(\mu -3\sigma < X < \mu +3\sigma):99.7\%$), окончательные результаты сегентации имеют уровень $Y: 98.7\%$.
\par Данный метод основан на анализе изображений, полученных в результате мультиспектральной съемки \cite{catalina2009use, barnuevo2008ensayo}. Это позволяет получить большой объем информации и проводить глубокий анализ, однако такая съемка требует специализированного дорогостоящего оборудовния.
\par В \cite{kose2012statistical} описан похожий статистический метод:
\begin{enumerate}[nosep]
    \item Получение статистических свойств текущей области.
    \item Нормализация цветов в исходном изображении.
    \item Сегментация сыпучих и измельченных образцов.
    \item Применение статистической сегментации к пикселям, попавших в несколько классов в результате сегментации (при необходимости). 
    \item Применение метода увеличения области для дальнейшего улучшения используя предыдущие сегментированные пиксели (при необходимости).
    \item Заполнение кусочков, выпавших в результате шлифовки.
    \item Подсчет площади, размера, количества минералов и полостей на изображении. 
    \item Получение количественных и качественных значений для оценки результатов.
\end{enumerate}

\newpage
\section{Предлагаемый метод}
Предлагается использовать метод сегментации изображений аншлифов, основанный на применении сверточных нейронных сетей и последующей обработкой результатов сегментации математическими методами обработки изображений. \par Несмотря на то, что методы глубокого обучения и, в частности, свёрточные нейронные сети приобретают все большую популярность,  примеров их использования в задачах анализа геологических изображений крайне мало, а имеющиеся примеры созданы с целью решения узких задач, таких как определение фазовых переходов вещества по снимкам XRF-микроанализатора, или определения количества органического компонента в шлифе \cite{osnkonstrmeh, disser1}. \par Нейросетевые модели отличаются хорошей обобщающей способностью, что вместе с применением современных математических методов обработки изображений делает их чрезвычайно полезным инструментом, который может быть использован для обработки и анализа геологических изображений, и позволяет рассчитывать на получение хороших результатов в решении поставленных задач.
\par В качестве нейросетевой модели для осуществления сегментации изображений в данной работе используется сверточная нейронная сеть U-Net \cite{ronneberger2015u}.
\newline
\begin{figure}[H]
    \centering
    \includegraphics[width=0.75\textwidth]{pics/u-net.png}
    \caption{Архитектура сети U-Net. \textbf{Conv} - свертка, \textbf{max pool} - субдискретизация с выбором максимума, \textbf{up-conv} - транспонированая свертка.}
    % , \textbf{ReLU:} $f(x)=\begin{cases}
    % 0, & x<0 \\ x, & x \geqslant 0 \end{cases}$}
    \label{fig:unet}
\end{figure}
\newline
\par
Архитектура сети представляет собой полносвязную сверточную сеть, модифицированную так, чтобы она могла работать с меньшим количеством обучающих данных и делала более точную сегментацию. \par
Сеть содержит сжимающий путь (кодировщик) и расширяющий путь (декодировщик). Кодировщик состоит из сверточных блоков: две свертки с ядром $3 \times 3$, функцию активации $ReLu$ \footnote {$f(x)=\begin{cases} 0, & x<0 \\ x, & x \geqslant 0 \end{cases}$} и Max Pooling \footnote {слой субдискретизации с выбором максимума} $2 \times 2$ с шагом 2.
Декодировщик включает в себя блоки, состоящие из транспонированной свертки, свертки с ядром $2 \times 2$, конкатенации с соответствующим образом обрезанной карты признаков из кодировщика, затем идут две свертки с ядром $3 \times 3$ и функцией активации $ReLu$.  

\par Чем больше слоев используется в сети - тем выше обобщающая способность нейросети, тем самым качество сегментации повышается. С другой стороны, увеличение количества слоёв сети приводит к увеличению числа параметров, что требует больщего количества данных для обучения. На рисунке \ref{fig:unet} показана нейронная сеть с 4 слоями.

\newpage
\section{Проблема несбалансированности данных}
Используемые в данной работе изображения аншлифов были сделаны по рудам свинцовоцинковых месторождений, относимых к колчеданному промышленному типу, который
связан с базальтовыми лавами. Все основные особенности месторождений и, в первую
очередь, состав руд (соотношения меди, цинка, свинца) обусловлены типом рудоносных
формаций. Среди основных минералов руд выделяются сфалерит (сульфид цинка),
халькопирит (сульфид меди), пирит (сульфид железа) и галенит (сульфид свинца). В
данном случае распределение металлов следующее: цинк – 60\%, медь – 30\%, свинец – 10\%.
Железо является вредной, не извлекаемой примесью и по этой причине не учитывается в
соотношении полезных ископаемых. Распространение рудных минералов соответствует
распределению металлов. Самый часто встречаемый минерал на изображениях – сфалерит,
менее распространённый пирит, за тем по встречаемости идёт халькопирит и наименее
распространённый минерал – галенит. 
\par В используемом наборе фотографий минерал галенит (\textbf{Gl}) пристутствует только на $6.7\%$ от общего числа пикселей. В то время как доля \textbf{Background}, \textbf{Sh}, \textbf{Py/Mrc} составляет $33.7\%$, $29.3\%$ и $30.3\%$ соответственно.
\par
На вход нейронной сети подается фрагмент изображения (патч), который случайным образом вырезается из целого изображения. При случайном выборе патчей дисбаланс данных увеличивается. На тестовой выборке, состоящей из 1000 патчей, доля \textbf{Gl} составила менее $3\%$. Таким образом, необходимо разработать и реализовать алгоритм, ползволяющий вырезать из каждого изображения патч, содержащий наибольшее количество пикселей, относящихся к конкретному классу.
\newline
Предлагается алгоритм, выполняющийся на каждом шаге эпохи обучения:
\begin{enumerate}[nosep]
    \item Выбор класса
    \item Выбор изображения
    \item Выбор патча
\end{enumerate}
Рассмотрим алгорит подробнее.
\subsection{Выбор класса}
Для поддержания сбалансированности количества пикселей каждого из классов изображения на этом шаге необходимо выбрать класс, число пикселей которого минимально среди всех пикселей, выбранных раньше.
Пусть далее статистика - словарь <ключ> - <значение>. Ключом является \textbf{id} класса, значением - число пикселей данного класса, которые уже попали на патчи. Номер искомого класса - это ключ, значение которого минимально в статистике. Статистика обновляется после каждого выбора патча.
\subsection{Выбор изображения}
После того, как стало известно, какой класс на данной итерации мы хотим выбирать, необходимо выбрать изображение, из которого будет вырезан патч. Для каждого из классов заранее был составлен словарь, ключом которого является \textbf{id} изображения, на котором данный класс присутствует. Значением является число пикселей, принадлежащих этому классу на изображении. 
\par
На каждом шаге необходимо выбирать $b$ патчей, где $b$ - размер стопки (batch size). Соответственно, необходимо выбрать $b$ изображений, в каждом из которых будет вырезан патч. Каждое изображение выбирается с вероятностью, равной числу пикселей класса на нем. Таким образом, на этом шаге мы получаем массив из $b$ элементов, каждый из которых является \textbf{id} изображения, на котором больше всего пикселей данного класса.
\subsection{Выбор патча}
После получения массива с \textbf{id} изображений, на каждом таком изображении необходимо выбрать патч, содержащий наибольшее число пикселей данного класса. Для этого необходимо построить для каждого из изображений карту вероятностей того, что верхний левый угол патча будет выбран в данном пикселе. Карта вероятностей строится для каждого класса отдельно. Алгоритм построения карты вероятностей:
\begin{enumerate}
    \item Построение карты расстояний до класса
    \item Построение интегрального изображения
    \item Построение карты вероятностей выбора патча
\end{enumerate}
Рассмотрим алгоритм подробнее.
\subsubsection{Построение карты расстояний до класса}
Для построения карты вероятностей до класса воспользуемся преобразованием Distance transform.
Рассмотрим бинарное изображение $I(x,y)$. Оно может быть разделено на две части: объект и фон.
$$
I(x, y) \in\{O b, B g\}
$$
Результатом преобразования является карта (изображение) $I_{d}(x,y)$, каждый пиксель которого содержит расстояние от этого пикселя до ближайшего пикселя объекта на изображении $I(x,y)$.
$$
I_{d}(x, y)=\left\{\begin{array}{ll}
0, & I(x, y) \in\{O b\} \\
\min \left(\| x-x_{0}, y-y_{0} \|, \forall I\left(x_{0}, y_{0}\right) \in B g\right), & I(x, y) \in\{B g\}
\end{array}\right.
$$
$$
\|x, y\|_{L_{2}}=\sqrt{x^{2}+y^{2}}
$$
Рассмотрим на примере изображения $5 \times 5$.
$$
I = 
\begin{bmatrix}
 0&0&0&0&0 \\
 0&1&0&0&0 \\
 0&1&1&1&1 \\
 0&1&1&0&0 \\
 0&0&0&0&0
\end{bmatrix}
\quad
I_d=
\begin{bmatrix}
 \sqrt{2}&1&\sqrt{2}&2&2 \\
 1&0&1&1&1 \\
 1&0&0&0&0 \\
 1&0&0&1&1 \\
 \sqrt{2}&1&1&\sqrt{2}&2
\end{bmatrix}
$$

\subsubsection{Построение интегрального изображения}
Интегральным изображением (summed-up area table) называется изображение, каждый пиксель которого является суммой всех пикселей исходного изображения выше и левее текущего, включительно. Пусть $I(x, y)$ - исходное изображение. Тогда интегральным изображением от изображения $I(x, y)$ является
$$
I(x, y)=\sum_{x^{\prime} \leq x \atop y^{\prime} \leq y} i\left(x^{\prime}, y^{\prime}\right)
$$
Интегральное изображение позволяет быстро и эффективно посчитать сумму пикселей в любой прямоугольной области изображения, так как
$$
I_{int}(x, y)=I(x, y)+I_{int}(x, y-1)+I_{int}(x-1, y)-I_{int}(x-1, y-1)
$$
После того, как интегральное изображение было подсчитано, сумма значений в прямоугольнике $[x_0, x_1] \times [y_0, y_1]$ может быть подсчитана так:
$$
\sum_{x_{0}<x \leq x_{1} \atop y_{0}<y \leq y_{1}} i(x, y)=I(D)+I(A)-I(B)-I(C),
$$
где $A=(x_0, y_0),~B=(x_1, y_0),~C=(x_0, y_1),~D=(x_1, y_1).$
\newline
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\textwidth]{pics/Summed_area_table.png}
    \caption{Вычисление суммы прямоугольной области при помощи интегрального изображения}
    \label{fig:summed0}
\end{figure}
\newpage
Рассмотрим вычисление суммы подробнее на примере изображения $6 \times 6$.
\newline
\begin{figure}[H]
    \centering
    \includegraphics[width=0.25\textwidth]{pics/summedup1.png}
    \caption{Изначальное изображение. Хотим вычислить сумму в фиолетовой области.}
    \label{fig:summed1}
\end{figure}
\begin{figure}[H]
    \centering
    \includegraphics[width=0.25\textwidth]{pics/summedup2.png}
    \caption{Интегральное изображение. Хотим вычислить сумму в фиолетовой области.}
    \label{fig:summed2}
\end{figure}

\subsubsection{Построение карты вероятностей выбора патча}
Применим к изображению $I(x,y)$ преобразование Distance transform ($I_{d}(x, y)$) и построим интегральное изображение от этого преобразования ($I_{int}(x,y)$). Рассмотрим на изображении квадратную область размера $p \times p$, где $p$ - ширина патча. Очевидно, что чем меньше сумма в соответствующей области на $I_{d}(x,y)$,
тем больше пикселей данного класса находится в соответствующей области изображения $I(x,y)$. 
\par Пусть $\tilde{I}_{d}(x,y) = 1 - \frac{I_{d}(x,y)}{max(I_{d}(x,y))}$, а соответствующее интегральное изображение обозначим $\tilde{I}_{int}(x,y)$. Получили, что чем \textit{больше} сумма в соответствующей области на $\tilde{I}_{d}(x,y)$, тем больше пикселей данного класса находится в соответствующей области изображения $I(x,y)$. Таким образом, при помощи $\tilde{I}_{int}(x,y)$ мы можем получить искомую карту вероятностей $P(x,y)$, в каждом пикселе которого содержится число, равное сумме расстояний от данного класса до фоновых пикселей. Очевидно, что чем значение в пикселе $P(x,y)$ выше, тем выше вероятность того, что при выборе патча с верхним левым углом в данном пикселе, на патч попадет наибольшее количество пикселей искомого класса. Таким образом, была получена карта вероятностей того, что левый верхний угол патча необходимо выбрать в данном пикселе с целью захватить наибольшее число пикслей данного класса.
\par Рассмотрим теперь данный алгоритм на примере изображения из обучающего набора. Предположим, что необходимо выбрать патч, содержащий наибольшее число пикселей, принадлежащих классу \textbf{Gl}, на изображении он размечен светло-зеленым цветом.
\newline
\begin{figure}[H]
    \centering
    \includegraphics[width=0.95\textwidth]{pics/GL.png}
    \caption{Пример выбора патча. Слева - оригинальное изображение, справа - карта вероятностей.}
    \label{fig:algo}
\end{figure}
\par Красным цветом на карте вероятностей обозначены области, выбрав левый верхний угол патча в которых, мы получим наибольшее число пикселей нужного класса. Чем "холоднее" область, тем меньше вероятность попадания пикселей нужного класса на патч. "Холодная" рамка снизу и справа карты вероятностей, имеющая ширину, равную ширине патча, возникает из-за того, что в этой области нельзя выбрать выбрать патч, так как он выйдет за границы изображения.
\par Предложенный алгоритм балансировки данных позволяет добиться равного соотношения для каждого из классов. Это было проверено путем подсчета количества пикселей для каждого класса на большой выборке патчей (порядка 10000), полученных данным алгоритмом.

\subsection{Взвешенная функция потерь}


\newpage
\bibliography{bibliography}

\end{document}